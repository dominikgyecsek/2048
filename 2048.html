<!DOCTYPE html>
<html>
<head>
	<title>2048</title>
	<link href='https://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>

	<style>

	body {
		font-size: 30px;
		text-align: center;
		font-family: 'Droid Sans';
		width: 100%;
		height: 100%;
		margin: 0;
		box-sizing: border-box;
	}

	#wrapper {
		width: 100%;
		background-color: rgb(200, 200, 200);
		height: 100vh;
		display: flex;
		justify-content: center;
	}

	#game {
		width: 500px;
		height: 557px;
		margin: 0 auto;
		border: 3px solid rgb(160,160,160);
		border-radius: 10px;
		padding: 4px;
		align-self: center;
	}

	#toolbar {
		height: 50px;
		width: 510px;
		margin: auto;
		right: 6px;
		position: relative;
		border-bottom: 3px solid rgb(160,160,160);
		color: #656565;
		font-size: 26px;
		margin-bottom: 4px;
	}

	#toolbar>span {
		padding: 8px 15px;
	}

	.tile {
		width: 90px;
		height: 90px;
		float: left;
		line-height: 90px;
		border-radius: 13px;
		border: 5px solid rgb(200, 200, 200);
	}

	#restart-btn {
		border: none;
		background-color: transparent;
		cursor: pointer;
		color: #656565;
		font-size: 26px;
	}

	.new {
		animation-name: scaleUp;
		animation-duration: 0.1s;
		animation-fill-mode: forwards;
	}

	.old {
		animation-name: scaleDown;
		animation-duration: 0.1s;
		animation-fill-mode: forwards;
	}

	@keyframes scaleUp {
		0% { transform: scale(0.1,0.1); }
		100% { transform: scale(1,1); }
	}

	@keyframes scaleDown {
		0% { transform: scale(1,1); }
		100% { transform: scale(0.1,0.1); }
	}

	.right { float: right; }
	.left { float: left;  }

	.color-2 { background-color: #69D2E7; color: #FA6900; }
	.color-4 { background-color: #FA6900; color: #69D2E7; }
	.color-8 { background-color: #ECD078; color: #C02942; }
	.color-16 { background-color: #C02942; color: #ECD078; }
	.color-32 { background-color: #A8DBA8; color: #3B8686; }
	.color-64 { background-color: #3B8686; color: #A8DBA8; }
	.color-128 { background-color: #774F38; color: #F1D4AF; }
	.color-256 { background-color: #F1D4AF; color: #774F38; }
	.color-512 { background-color: #547980; color: #E5FCC2; }
	.color-1024 { background-color: #E5FCC2; color: #547980; }
	.color-2048 { background-color: #00A0B0; color: #6A4A3C; }
	.color-4096 { background-color: #6A4A3C; color: #00A0B0; }
	.color-8192 { background-color: #E94E77; color: #C6E5D9; }
	.color-16384 { background-color: #C6E5D9; color: #E94E77; }
	.color-32768 { background-color: #FFFFFF; color: #1C140D; }
	.color-65536 { background-color: #1C140D; color: #FFFFFF; }
	.color-131072 { background-color: #73626E; color: #F7E4BE; font-size: 25px; }
	.color-262144 { background-color: #F7E4BE; color: #73626E; font-size: 25px; }
	.color-524288 { background-color: #005F6B; color: #00DFFC; font-size: 25px; }
	.color-1048576 { background-color: #00DFFC; color: #005F6B; font-size: 21px; }
	.color-2097152 { background-color: #645543; color: #BF4D28; font-size: 21px; }
	.color-4194304 { background-color: #BF4D28; color: #645543; font-size: 21px; }
	.color-8388608 { background-color: #8FBE00; color: #00A8C6; font-size: 21px; }
	.color-16777216 { background-color: #00A8C6; color: #8FBE00; font-size: 19px; }
	.color-33554432 { background-color: #FF9900; color: #424242; font-size: 19px; }

	</style>
</head>
<body>

<div id="wrapper">
	<div id="game">
		<div id="toolbar">
			<span class="left">
				<span id="score-label"></span>
				<span id="score"></span> 
			</span>
			<span class="right">
				<button id="restart-btn"> Restart </button>
			</span>
		</div>
		<div class="tile" id="1"></div>
		<div class="tile" id="2"></div>
		<div class="tile" id="3"></div>
		<div class="tile" id="4"></div>
		<div class="tile" id="5"></div>
		<div class="tile" id="6"></div>
		<div class="tile" id="7"></div>
		<div class="tile" id="8"></div>
		<div class="tile" id="9"></div>
		<div class="tile" id="10"></div>
		<div class="tile" id="11"></div>
		<div class="tile" id="12"></div>
		<div class="tile" id="13"></div>
		<div class="tile" id="14"></div>
		<div class="tile" id="15"></div>
		<div class="tile" id="16"></div>
		<div class="tile" id="17"></div>
		<div class="tile" id="18"></div>
		<div class="tile" id="19"></div>
		<div class="tile" id="20"></div>
		<div class="tile" id="21"></div>
		<div class="tile" id="22"></div>
		<div class="tile" id="23"></div>
		<div class="tile" id="24"></div>
		<div class="tile" id="25"></div>
	</div>
</div>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

<script>

	$(document).ready(function() {

		initialize();

		$("html").keydown(function(e){

			switch (e.keyCode) {

				case 65: direction = [1,6,11,16,21,1]; break;
				case 83: direction = [21,22,23,24,25,-5]; break;
				case 68: direction = [5,10,15,20,25,-1]; break;
				case 87: direction = [1,2,3,4,5, 5]; break;
				default: return;

			}

			if ( !shiftTiles() ) return;
			generateTile();
			drawTiles();

		});

		$("#restart-btn").click(initialize);

	})

	var direction, isValidMove, table, score;

	/*var table = [ null,
		0, 4, 8, 16, 32,
		64, 128, 256, 512, 1024,
		2048, 4096, 8192, 16384, 32768,
		65536, 131072, 262144, 524288, 1048576,
		2097152, 4194304, 8388608, 16777216, 33554432
	]*/

	

	function initialize() {
		table = [null,
			0,0,0,0,0,
			0,0,0,0,0,
			0,0,0,0,0,
			0,0,0,0,0,
			0,0,0,0,0
		]
		generateTile();
		drawTiles();
		score = 0;
		$("#score").text("");
		$("#score-label").text("Use W,A,S,D to move");
	}

	function drawTiles() {

		$(".tile").addClass("old");

		setTimeout(function() {

			for (var i = 2; i <= 33554432; i *= 2) {
				$(".color-" + i).removeClass("color-" + i);
			}

			$(".tile").removeClass("old").addClass("new");

			for (var i = 1; i < table.length; i++) {
				var value = table[i];
				if (value == 0) value = "";
				$("#" + i).text(value).addClass("color-" + value);
			}

		}, 100)


	}

	function shiftTiles() {

		var multi = direction[5];
		isValidMove = false;

		for (var i = 0; i < 5; i++) {

			var startIndex = direction[i]
			var indexes = [ startIndex, startIndex + multi, startIndex + multi*2, startIndex + multi*3, startIndex + multi*4 ];
			var values = [0, 0, 0, 0, 0];

			for (var j = 0; j < 5; j++) {

				var index = indexes[j];
				values[j] = table[index];

			}

			if ( !isEmpty(values) ) {

				values = shiftZeros(JSON.parse(JSON.stringify(values)));
				values = mergeTiles(JSON.parse(JSON.stringify(values)));
				values = shiftZeros(JSON.parse(JSON.stringify(values)));

				storeTempTables(indexes, values, false);

			}

		}

		storeTempTables(null, null, true);

		return isValidMove;
		//return true;

	}

	var indexesTemp = [], valuesTemp = [], iterationCount = 0;

	function storeTempTables (indexes, values, isFinished) {

		if ( !isFinished ) {

			indexesTemp.push(indexes);
			valuesTemp.push(values);
			iterationCount++;

		} else {

			if ( isValidMove ) {

				for (var i = 0; i < indexesTemp.length; i++) {

					var valuesRow = valuesTemp[i];
					var indexesRow = indexesTemp[i];

					for (var j = 0; j < 5; j++) {

						var index = indexesRow[j];
						table[index] = valuesRow[j];

					}

				}

				iterationCount = 0;
				indexesTemp = [];
				valuesTemp = [];

			}

		}

	}

	function shiftZeros(values) {

		var valuesOld = JSON.parse(JSON.stringify(values));
		var values = JSON.parse(JSON.stringify(values));

		for (var i = 0; i < 5; i++) {

			if ( values[i] == 0 ) {
				values.splice(i, 1);
				i--;
			}

		}

		while ( values.length != 5 ) {
			values.push(0);
		}

		if ( !isSameArray(valuesOld, values) ) isValidMove = true;

		return values;

	}

	function isSameArray(arr1, arr2) {

		if ( arr1.length != arr2.length ) return false;
		for (var i = 0; i < arr1.length; i++) if (arr1[i] != arr2[i]) return false;
		return true;

	}

	function mergeTiles(values) {

		var valuesOld = JSON.parse(JSON.stringify(values));
		var values = JSON.parse(JSON.stringify(values));

		for (var i = 0; i < 4; i++) {

			if ( values[i] == values[i+1] ) {
				values[i] = values[i] * 2;
				score += values[i]
				$("#score").text(score);
				$("#score-label").text("Score: ");
				values[i+1] = 0;
				break;
			}

		}

		if ( !isSameArray(valuesOld, values) ) isValidMove = true;

		return values;

	}

	function isEmpty (arr) {

		if ( arr.join("") == "00000" )
			return true;
		return false;

	}

	function generateTile() {

		var foundSpace = false;

		while (!foundSpace) {
			var random = getRandomInt(1, 25);
			if ( table[random] == 0 ) {
				table[random] = 2;
				//$(".new").removeClass("new");
				//$("#" + random).addClass("new");
				foundSpace = true;
			}	
		}

		foundSpace = false;

	}

	function getRandomInt(min, max) {

    	return Math.floor(Math.random() * (max - min + 1)) + min;

	} 

</script>

</body>
</html>